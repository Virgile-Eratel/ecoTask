# GitLab CI/CD Configuration pour EcoTaskv2
# Application de gestion de tâches avec suivi d'impact environnemental

# Image de base Node.js
image: node:18-alpine

# Variables globales
variables:
  NODE_ENV: "test"
  DATABASE_URL: "file:./test.db"
  JWT_SECRET: "test"

# Cache pour optimiser les builds
cache:
  key: 
    files:
      - package-lock.json
      - backend/package-lock.json
  paths:
    - node_modules/
    - backend/node_modules/
    - .yarn/cache/

# Stages de la pipeline
stages:
  - install
  - lint
  - test
  - build
  - docker-build
  - deploy

# Installation des dépendances
install_dependencies:
  stage: install
  script:
    - echo $CI_REGISTRY_IMAGE
  artifacts:
    paths:
      - node_modules/
      - backend/node_modules/
    expire_in: 1 hour
  only:
    - merge_requests
    - main
    - develop
